version: '3'

vars:
  PYTHON_VERSION:
    sh: |
      cat .python-version
  AIRFLOW_VERSION: '{{.AIRFLOW_VERSION}}'
  CONSTRAINT_URL: "https://raw.githubusercontent.com/apache/airflow/constraints-{{.AIRFLOW_VERSION}}/constraints-{{.PYTHON_VERSION}}.txt"

  OPEN_CMD: '{{eq OS "linux" | ternary "xdg-open" "open" }}'

dotenv: [ '.env' ]

silent: true
tasks:
  default:
    cmds:
      - echo {{.AIRFLOW_VERSION}}

  sync:
    cmds:
      - defer: rm requirements.txt
      - uv sync
      - sed -i 's/apache-airflow==.*/apache-airflow=={{.AIRFLOW_VERSION}}/g' requirements.in
      - uv pip compile -c {{.CONSTRAINT_URL}} -o requirements.txt requirements.in
      - uv pip install -r requirements.txt

  pcrun:
    cmds:
      - process-compose -D
      - "echo airflow admin password: $(cat airflow/standalone_admin_password.txt)"
      - sleep 5s
      - "{{.OPEN_CMD}} http://localhost:8080"
      - "{{.OPEN_CMD}} http://localhost:8888"
      - "{{.OPEN_CMD}} http://localhost:5000"
