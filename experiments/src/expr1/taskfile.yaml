version: '3'

vars:
  PYTHON_VERSION:
    sh: |
      cat .python-version
  AIRFLOW_VERSION: '{{.AIRFLOW_VERSION}}'
  CONSTRAINT_URL: "https://raw.githubusercontent.com/apache/airflow/constraints-{{.AIRFLOW_VERSION}}/constraints-{{.PYTHON_VERSION}}.txt"

dotenv: [ '.env' ]

silent: true
tasks:
  default:
    cmds:
      - echo {{.AIRFLOW_VERSION}}

  sync:
    cmds:
      - sed -i 's/apache-airflow==.*/apache-airflow=={{.AIRFLOW_VERSION}}/g' requirements.in
      - uv pip compile -c {{.CONSTRAINT_URL}} -o requirements.txt requirements.in
      - uv pip install -r requirements.txt
      - uv pip sync requirements.txt
